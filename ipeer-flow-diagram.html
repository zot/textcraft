<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPeer Flow Diagram - Textcraft</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --border-color: #dee2e6;
            --code-bg: #f5f5f5;
            --link-color: #0066cc;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #1e1e1e;
                --bg-secondary: #2d2d2d;
                --text-primary: #e0e0e0;
                --text-secondary: #a0a0a0;
                --border-color: #404040;
                --code-bg: #2d2d2d;
                --link-color: #4da6ff;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--bg-primary);
        }

        header {
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        h2 {
            font-size: 2rem;
            margin-top: 40px;
            margin-bottom: 20px;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }

        h3 {
            font-size: 1.5rem;
            margin-top: 30px;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        p {
            margin-bottom: 15px;
        }

        .mermaid {
            background-color: var(--bg-secondary);
            padding: 30px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        pre {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            padding: 15px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        code {
            background-color: var(--code-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9em;
        }

        pre code {
            background-color: transparent;
            padding: 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        th {
            background-color: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
        }

        tr:nth-child(even) {
            background-color: var(--bg-secondary);
        }

        ul {
            margin-left: 30px;
            margin-bottom: 15px;
        }

        li {
            margin-bottom: 8px;
        }

        .section {
            margin-bottom: 50px;
        }

        .pattern-box {
            background-color: var(--bg-secondary);
            border-left: 4px solid var(--link-color);
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .toc {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }

        .toc h3 {
            margin-top: 0;
        }

        .toc ul {
            margin-left: 20px;
        }

        .toc a {
            color: var(--link-color);
            text-decoration: none;
        }

        .toc a:hover {
            text-decoration: underline;
        }

        footer {
            margin-top: 60px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .checkmark {
            color: #28a745;
            font-weight: bold;
        }

        @media print {
            body {
                background-color: white;
                color: black;
            }
            .mermaid {
                background-color: #f8f9fa;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>IPeer Flow Diagram</h1>
            <p class="subtitle">How the IPeer abstraction is used throughout the Textcraft application, from initialization through various user interactions and P2P operations.</p>
        </header>

        <div class="toc">
            <h3>Table of Contents</h3>
            <ul>
                <li><a href="#architecture">Application Architecture with IPeer</a></li>
                <li><a href="#patterns">Key IPeer Usage Patterns</a></li>
                <li><a href="#lifecycle">State Diagram: Peer Lifecycle</a></li>
                <li><a href="#matrix">IPeer Interface Methods - Usage Matrix</a></li>
                <li><a href="#files">Files Involved</a></li>
            </ul>
        </div>

        <section class="section" id="architecture">
            <h2>Application Architecture with IPeer</h2>
            <div class="mermaid">
flowchart TD
    %% Initialization
    Start([Browser loads textcraft.html]) --> OnLoad[window.onload]
    OnLoad --> InitModules[Initialize all modules<br/>textcraft.ts]
    InitModules --> InitPeer[mudproto.ts calls setCurrent<br/>registers MudProtoPeer implementation]
    InitPeer --> OpenStorage[Model.openStorage]
    OpenStorage --> GuiStart[Gui.start]
    GuiStart --> PeerStart[peer.start<br/>MudStorage]
    PeerStart --> Ready([App Ready])

    %% User interactions
    Ready --> UserChoice{User Action}

    %% Host path
    UserChoice -->|Click 'Host'| HostBtn[GUI: #mud-host button]
    HostBtn --> StartHost[peer.startHosting]
    StartHost --> BecomeHost[Strategy: HostStrategy<br/>Load/create MUD world]
    BecomeHost --> ShowConnStr[Display connection string]
    ShowConnStr --> HostLoop{User actions<br/>while hosting}

    %% Guest path
    UserChoice -->|Click 'Join'| GuestBtn[GUI: #connect button]
    GuestBtn --> JoinInput[User enters host connection string]
    JoinInput --> JoinSession[peer.joinSession<br/>session string]
    JoinSession --> BecomeGuest[Strategy: GuestStrategy<br/>Connect to host]
    BecomeGuest --> GuestLogin[Login to MUD]
    GuestLogin --> GuestLoop{User actions<br/>while guest}

    %% Relay path
    UserChoice -->|Click 'Relay'| RelayBtn[GUI: #mud-select-relay button]
    RelayBtn --> StartRelayOp[peer.startRelay]
    StartRelayOp --> BecomeRelay[Strategy: RelayStrategy<br/>Forward traffic]
    BecomeRelay --> RelayLoop{Relay running}

    %% Host via Relay path
    UserChoice -->|Click 'Host via Relay'| RelayHostBtn[GUI: #host-with-relay button]
    RelayHostBtn --> RelayHostInput[User enters relay connection string]
    RelayHostInput --> HostViaRelay[peer.hostViaRelay<br/>sessionID]
    HostViaRelay --> BecomeRelayHost[Strategy: RelayHostStrategy<br/>Host behind NAT]
    BecomeRelayHost --> HostLoop

    %% Host operations
    HostLoop -->|Guest changes name| NameChange[mudcontrol.ts detects<br/>thing.name changed]
    NameChange --> UserThingChanged[peer.userThingChanged<br/>thing]
    UserThingChanged --> UpdateUserMap[Update internal UserInfo map]
    UpdateUserMap --> BroadcastSetUser[Broadcast 'setUser' command<br/>to all guests]
    BroadcastSetUser --> HostLoop

    HostLoop -->|Guest sends command| GuestCmd[Receive command from guest]
    GuestCmd --> RouteToMud[Route to guest's MudControl]
    RouteToMud --> ExecuteHost[Execute in MUD world]
    ExecuteHost --> SendResult[Send result to guest]
    SendResult --> HostLoop

    %% Guest operations
    GuestLoop -->|User types command| InputCmd[mudcontrol.ts receives input]
    InputCmd --> PeerCommand[peer.command<br/>cmd text]
    PeerCommand --> SendToHost[Send to host via P2P]
    SendToHost --> WaitResult[Wait for response]
    WaitResult --> DisplayOutput[gui.ts displays output]
    DisplayOutput --> GuestLoop

    GuestLoop -->|Name changed locally| GuestNameChange[mudcontrol.ts: thing.name changed]
    GuestNameChange --> GuestUserThingChanged[peer.userThingChanged<br/>thing]
    GuestUserThingChanged --> SendNameToHost[Send to host<br/>host propagates to others]
    SendNameToHost --> GuestLoop

    %% Quit/Reset
    HostLoop -->|Click 'Quit'| Quit[GUI: #mud-quit button]
    GuestLoop -->|Click 'Quit'| Quit
    RelayLoop -->|Click 'Stop'| Quit
    Quit --> PeerReset[peer.reset]
    PeerReset --> Disconnect[Disconnect all peers<br/>Clear network state]
    Disconnect --> MudQuit[mudcontrol.quit]
    MudQuit --> Ready

    %% Version checking
    Ready -.->|GUI polls| CheckVersion{peer.currentVersionID<br/>vs peer.versionID}
    CheckVersion -.->|Mismatch| ShowUpdate[Show update notification]
    CheckVersion -.->|Match| HideUpdate[Hide update notification]

    style Start fill:#e1f5ff
    style Ready fill:#d4edda
    style BecomeHost fill:#fff3cd
    style BecomeGuest fill:#fff3cd
    style BecomeRelay fill:#fff3cd
    style BecomeRelayHost fill:#fff3cd
    style UserThingChanged fill:#ffd6d6
    style PeerCommand fill:#ffd6d6
            </div>
        </section>

        <section class="section" id="patterns">
            <h2>Key IPeer Usage Patterns</h2>

            <div class="pattern-box">
                <h3>1. Initialization Flow</h3>
                <pre>textcraft.ts (entry point)
    ↓
mudproto.ts: setCurrent(MudProtoPeer)
    ↓
peer.current = MudProtoPeer instance
    ↓
All modules can now: import {current as peer} from './peer'</pre>
            </div>

            <div class="pattern-box">
                <h3>2. Module Import Pattern</h3>
                <pre><code class="language-typescript">// In gui.ts, mudcontrol.ts, etc.
import {current as peer} from './peer'

// Then use directly:
peer.startHosting()
peer.command("look")
peer.userThingChanged(thing)</code></pre>
            </div>

            <div class="pattern-box">
                <h3>3. Host Workflow</h3>
                <pre>User clicks "Host" button
    ↓
gui.ts: peer.startHosting()
    ↓
mudproto.ts: Creates HostStrategy
    ↓
Loads MUD from storage OR creates new world
    ↓
Displays connection string to GUI
    ↓
Listens for guest connections
    ↓
When guest connects:
  - Creates MudControl for guest
  - Syncs world state
  - Routes commands bidirectionally</pre>
            </div>

            <div class="pattern-box">
                <h3>4. Guest Workflow</h3>
                <pre>User clicks "Join" → enters connection string
    ↓
gui.ts: peer.joinSession(connectionString)
    ↓
mudproto.ts: Creates GuestStrategy
    ↓
Connects to host via libp2p
    ↓
Login process (name selection)
    ↓
mudcontrol.ts: All commands go through peer.command()
    ↓
Commands sent to host → executed → results returned</pre>
            </div>

            <div class="pattern-box">
                <h3>5. User Synchronization (userThingChanged)</h3>
                <pre>mudcontrol.ts detects: this.thing.name !== this.myName
    ↓
peer.userThingChanged(this.thing)
    ↓
mudproto.ts (host only):
  - Looks up peerID for thing
  - Updates UserInfo map: {peerID, newName}
  - Creates 'setUser' command
  - Broadcasts to all guests
  - (Relay mode: also sends to relay server)
    ↓
All peers now see updated username</pre>
            </div>

            <div class="pattern-box">
                <h3>6. Command Routing</h3>
                <pre>Guest:
  User input → mudcontrol.ts → peer.command(text)
    → Send to host over P2P
    → Host executes
    → Result sent back
    → gui.ts displays

Host:
  Command arrives from guest
    → peer routes to correct guest's MudControl
    → Executes in shared world
    → Results sent to affected peers</pre>
            </div>
        </section>

        <section class="section" id="lifecycle">
            <h2>State Diagram: Peer Lifecycle</h2>
            <div class="mermaid">
stateDiagram-v2
    [*] --> Empty: App starts
    Empty --> Ready: setCurrent(MudProtoPeer)<br/>peer.start(storage)

    Ready --> Host: peer.startHosting()
    Ready --> Guest: peer.joinSession(string)
    Ready --> Relay: peer.startRelay()
    Ready --> RelayHost: peer.hostViaRelay(sessionID)

    Host --> Hosting: Strategy = HostStrategy
    Guest --> Connected: Strategy = GuestStrategy
    Relay --> Relaying: Strategy = RelayStrategy
    RelayHost --> HostingViaRelay: Strategy = RelayHostStrategy

    Hosting --> Ready: peer.reset()
    Connected --> Ready: peer.reset()
    Relaying --> Ready: peer.reset()
    HostingViaRelay --> Ready: peer.reset()

    Hosting --> Hosting: peer.userThingChanged()<br/>peer.command()
    Connected --> Connected: peer.command()
    HostingViaRelay --> HostingViaRelay: peer.userThingChanged()<br/>peer.command()
            </div>
        </section>

        <section class="section" id="matrix">
            <h2>IPeer Interface Methods - Usage Matrix</h2>
            <table>
                <thead>
                    <tr>
                        <th>Method</th>
                        <th>GUI</th>
                        <th>MudControl</th>
                        <th>MudProto</th>
                        <th>Purpose</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><code>currentVersionID</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td>Version checking for updates</td>
                    </tr>
                    <tr>
                        <td><code>versionID</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td>Expected version comparison</td>
                    </tr>
                    <tr>
                        <td><code>init()</code></td>
                        <td></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td>App initialization</td>
                    </tr>
                    <tr>
                        <td><code>start()</code></td>
                        <td></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td>Network startup</td>
                    </tr>
                    <tr>
                        <td><code>reset()</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td>Disconnect & cleanup</td>
                    </tr>
                    <tr>
                        <td><code>connectString()</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td>Show to user for sharing</td>
                    </tr>
                    <tr>
                        <td><code>relayConnectString()</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td>Show for relay connections</td>
                    </tr>
                    <tr>
                        <td><code>startHosting()</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td></td>
                        <td>User clicks "Host"</td>
                    </tr>
                    <tr>
                        <td><code>joinSession()</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td></td>
                        <td>User clicks "Join"</td>
                    </tr>
                    <tr>
                        <td><code>startRelay()</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td></td>
                        <td>User clicks "Relay"</td>
                    </tr>
                    <tr>
                        <td><code>hostViaRelay()</code></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td></td>
                        <td>User requests relay hosting</td>
                    </tr>
                    <tr>
                        <td><code>userThingChanged()</code></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td>Name changes propagation</td>
                    </tr>
                    <tr>
                        <td><code>command()</code></td>
                        <td></td>
                        <td><span class="checkmark">✓</span></td>
                        <td></td>
                        <td>All MUD command execution</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="section" id="files">
            <h2>Files Involved</h2>
            <ul>
                <li><strong>peer.ts</strong> - IPeer interface definition, singleton export</li>
                <li><strong>mudproto.ts</strong> - MudProtoPeer implementation, strategies</li>
                <li><strong>gui.ts</strong> - UI buttons trigger peer operations, version display</li>
                <li><strong>mudcontrol.ts</strong> - Command routing, user sync via peer</li>
                <li><strong>textcraft.ts</strong> - Initialization orchestration</li>
                <li><strong>protocol-shim.ts</strong> - Underlying libp2p abstraction</li>
            </ul>
        </section>

        <footer>
            <p>Generated: 2025-10-18 | <a href="ipeer-flow-diagram.md">View Markdown Source</a></p>
            <p>Part of the <strong>Textcraft</strong> project documentation</p>
        </footer>
    </div>

    <script>
        // Initialize Mermaid with configuration
        mermaid.initialize({
            startOnLoad: true,
            theme: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            securityLevel: 'loose'
        });

        // Update theme when system preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            location.reload();
        });
    </script>
</body>
</html>
